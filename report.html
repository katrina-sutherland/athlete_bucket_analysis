import React, { useState, useMemo } from 'react';
import { Users, Trophy, ChevronDown, Calendar, Filter, User } from 'lucide-react';

// --- DATASETS ---
const DATA = {
    "Junior Men": {
        main: [
            { label: 'Rank 1 - 3', single: 2, double: 2, triple: 7 },
            { label: 'Rank 4 - 6', single: 5, double: 3, triple: 1 },
            { label: 'Rank 7 - 9', single: 4, double: 4, triple: 1 },
            { label: 'Rank 10 - 12', single: 7, double: 2, triple: 0 },
            { label: 'Rank 13 - 15', single: 3, double: 6, triple: 0 },
            { label: 'Rank 16 - 18', single: 3, double: 4, triple: 2 },
            { label: 'Rank 19 - 21', single: 4, double: 3, triple: 2 },
            { label: 'Rank 22 - 24', single: 2, double: 4, triple: 3 },
            { label: 'Rank 25 - 27', single: 1, double: 4, triple: 4 },
            { label: 'Rank 28 - 30', single: 4, double: 2, triple: 3 },
        ],
        outlier: { label: 'Rank 31 +', single: 27, double: 27, triple: 66 },
        colors: { single: 'bg-slate-600', double: 'bg-blue-500', triple: 'bg-sky-300' },
        textColors: { single: 'text-slate-600', double: 'text-blue-500', triple: 'text-sky-400' },
        yAxisMax: 9,
        outlierMax: 80
    },
    "Junior Women": {
        main: [
            { label: 'Rank 1 - 3', single: 1, double: 6, triple: 2 },
            { label: 'Rank 4 - 6', single: 4, double: 3, triple: 2 },
            { label: 'Rank 7 - 9', single: 1, double: 2, triple: 6 },
            { label: 'Rank 10 - 12', single: 2, double: 1, triple: 6 },
            { label: 'Rank 13 - 15', single: 1, double: 3, triple: 5 },
            { label: 'Rank 16 - 18', single: 3, double: 2, triple: 4 },
            { label: 'Rank 19 - 21', single: 1, double: 4, triple: 4 },
            { label: 'Rank 22 - 24', single: 3, double: 3, triple: 3 },
            { label: 'Rank 25 - 27', single: 2, double: 6, triple: 1 },
            { label: 'Rank 28 - 30', single: 2, double: 2, triple: 5 },
        ],
        outlier: { label: 'Rank 31 +', single: 9, double: 38, triple: 22 },
        colors: { single: 'bg-[#4a144d]', double: 'bg-[#ce73ce]', triple: 'bg-[#f2d4f2]' },
        textColors: { single: 'text-[#4a144d]', double: 'text-[#ce73ce]', triple: 'text-[#ce73ce]' },
        yAxisMax: 9,
        outlierMax: 45
    },
    // Fallbacks
    "U23 Men": { main: [], outlier: {}, colors: { single: 'bg-gray-500', double: 'bg-gray-400', triple: 'bg-gray-300' }, yAxisMax: 10, outlierMax: 50 },
    "Senior Men": { main: [], outlier: {}, colors: { single: 'bg-gray-500', double: 'bg-gray-400', triple: 'bg-gray-300' }, yAxisMax: 10, outlierMax: 50 }
};

// --- ATHLETE DB ---
const ATHLETES = [
    {
        id: 1, name: "HOCEVAR Ziga-Lin", category: "Junior Men", categoryType: "triple",
        highlights: [
            { rankGroup: "Rank 1 - 3", text: <><div><b>K1:</b> 3rd</div><div><b>X1:</b> 1st</div></> },
            { rankGroup: "Rank 4 - 6", text: <div><b>C1:</b> 4th</div> }
        ]
    },
    {
        id: 2, name: "Example Athlete (Double)", category: "Junior Men", categoryType: "double",
        highlights: [
            { rankGroup: "Rank 10 - 12", text: <><div><b>C1:</b> 11th</div><div><b>K1:</b> 12th</div></> }
        ]
    },
    {
        id: 4, name: "DANEK Hanna", category: "Junior Women", categoryType: "triple",
        highlights: [
            { rankGroup: "Rank 1 - 3", text: <div><b>K1:</b> 1st</div> },
            { rankGroup: "Rank 16 - 18", text: <div><b>X1:</b> 17th</div> },
            { rankGroup: "Rank 22 - 24", text: <div><b>C1:</b> 23rd</div> }
        ]
    },
    {
        id: 5, name: "BLUME Mina", category: "Junior Women", categoryType: "double",
        highlights: [
            { rankGroup: "Rank 1 - 3", text: <><div><b>X1:</b> 1st</div><div><b>K1:</b> 3rd</div></> }
        ]
    }
];

// --- COMPONENTS ---

// 1. Hover Card Component
const HoverCard = ({ athleteName, categoryType, rankGroup, text, colorClass }) => (
    <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-4 w-48 z-50 animate-in fade-in slide-in-from-bottom-2 duration-300">
        <div className="bg-white text-xs rounded shadow-xl overflow-hidden border border-gray-200">
            <div className="bg-white p-2 border-b border-gray-100 font-bold text-black truncate">
                {athleteName}
            </div>
            <div className="p-2">
                <div className="text-[10px] text-gray-500 uppercase tracking-wider mb-1">
                    {rankGroup} â€¢ <span className={`font-bold ${colorClass}`}>{categoryType.toUpperCase()}</span>
                </div>
                <div className="space-y-0.5 text-black">
                    {text}
                </div>
            </div>
        </div>
        {/* Arrow */}
        <div className="absolute left-1/2 -translate-x-1/2 -bottom-[6px] w-0 h-0 border-l-[6px] border-l-transparent border-r-[6px] border-r-transparent border-t-[6px] border-t-white drop-shadow-sm"></div>
    </div>
);

// 2. Single Bar Component
const Bar = ({ height, color, zIndex, type, activeAthlete, rankGroup, activeTextColors }) => {
    // Check if athlete has a highlight for THIS specific column type in THIS rank group
    const highlight = activeAthlete?.highlights.find(h => h.rankGroup === rankGroup);
    const isTargetType = activeAthlete?.categoryType === type;
    const shouldShow = highlight && isTargetType;

    return (
        <div 
            className={`relative w-full transition-all duration-500 ${color} ${shouldShow ? 'opacity-100 ring-2 ring-offset-1 ring-yellow-400' : 'opacity-80 hover:opacity-100'}`}
            style={{ height: height, zIndex: shouldShow ? 50 : zIndex }}
        >
            {shouldShow && (
                <HoverCard 
                    athleteName={activeAthlete.name}
                    categoryType={type}
                    rankGroup={rankGroup}
                    text={highlight.text}
                    colorClass={activeTextColors[type]}
                />
            )}
        </div>
    );
};

// 3. Chart Group (Cluster of 3 bars)
const ChartGroup = ({ data, maxVal, activeColors, activeTextColors, activeAthlete }) => {
    const getHeight = (val) => `${(val / maxVal) * 100}%`;

    return (
        <div className="relative flex flex-col justify-end items-center h-full flex-1 min-w-[20px]">
            {/* Bars Container */}
            <div className="flex items-end justify-center w-full h-full relative px-0.5">
                {/* Single */}
                <div className="w-full relative z-10">
                    <Bar height={getHeight(data.single)} color={activeColors.single} zIndex={10} type="single" activeAthlete={activeAthlete} rankGroup={data.label} activeTextColors={activeTextColors} />
                </div>
                {/* Double */}
                <div className="w-full relative z-20 -ml-1 md:-ml-2">
                    <Bar height={getHeight(data.double)} color={activeColors.double} zIndex={20} type="double" activeAthlete={activeAthlete} rankGroup={data.label} activeTextColors={activeTextColors} />
                </div>
                {/* Triple */}
                <div className="w-full relative z-30 -ml-1 md:-ml-2">
                    <Bar height={getHeight(data.triple)} color={activeColors.triple} zIndex={30} type="triple" activeAthlete={activeAthlete} rankGroup={data.label} activeTextColors={activeTextColors} />
                </div>
            </div>
            
            {/* X-Axis Label */}
            <div className="absolute -bottom-10 left-0 right-0 flex justify-center">
                <div className="transform -rotate-45 origin-center w-32 text-center -translate-x-1 translate-y-4">
                    <span className="text-[10px] md:text-xs font-bold text-black block">{data.label}</span>
                </div>
            </div>
        </div>
    );
};

// --- MAIN APP ---
const App = () => {
    const [selectedEvent, setSelectedEvent] = useState('2025 World Championships');
    const [selectedCategory, setSelectedCategory] = useState('Junior Men');
    const [selectedAthleteId, setSelectedAthleteId] = useState('');

    // Derived State
    const activeData = DATA[selectedCategory] || DATA["Junior Men"];
    const filteredAthletes = useMemo(() => ATHLETES.filter(a => a.category === selectedCategory), [selectedCategory]);
    const activeAthlete = filteredAthletes.find(a => a.id === parseInt(selectedAthleteId));

    // Handlers
    const handleCategoryChange = (e) => {
        setSelectedCategory(e.target.value);
        setSelectedAthleteId(''); // Reset athlete when category changes
    };

    return (
        <div className="min-h-screen bg-white p-6 md:p-12 font-sans text-black">
            
            {/* HEADER */}
            <h1 className="text-3xl md:text-4xl font-extrabold text-center mb-12 text-black tracking-tight">Athlete Bucket Analysis</h1>

            {/* CONTROLS */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12 max-w-7xl mx-auto">
                <div className="relative">
                    <label className="flex items-center gap-2 text-xs font-bold uppercase mb-2 text-black"><Calendar className="w-4 h-4" /> Event</label>
                    <div className="relative">
                        <select 
                            className="w-full bg-white border border-black text-black font-medium py-3 pl-4 pr-8 rounded appearance-none focus:outline-none focus:ring-2 focus:ring-black"
                            value={selectedEvent} onChange={e => setSelectedEvent(e.target.value)}
                        >
                            <option>2025 World Championships</option>
                            <option>2024 World Championships</option>
                            <option>2023 World Cup</option>
                        </select>
                        <div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none"><ChevronDown className="w-4 h-4" /></div>
                    </div>
                </div>

                <div className="relative">
                    <label className="flex items-center gap-2 text-xs font-bold uppercase mb-2 text-black"><Filter className="w-4 h-4" /> Category</label>
                    <div className="relative">
                        <select 
                            className="w-full bg-white border border-black text-black font-medium py-3 pl-4 pr-8 rounded appearance-none focus:outline-none focus:ring-2 focus:ring-black"
                            value={selectedCategory} onChange={handleCategoryChange}
                        >
                            <option>Junior Men</option>
                            <option>Junior Women</option>
                            <option>U23 Men</option>
                            <option>Senior Men</option>
                        </select>
                        <div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none"><ChevronDown className="w-4 h-4" /></div>
                    </div>
                </div>

                <div className="relative">
                    <label className="flex items-center gap-2 text-xs font-bold uppercase mb-2 text-black"><User className="w-4 h-4" /> Athlete</label>
                    <div className="relative">
                        <select 
                            className="w-full bg-white border border-black text-black font-medium py-3 pl-4 pr-8 rounded appearance-none focus:outline-none focus:ring-2 focus:ring-black"
                            value={selectedAthleteId} onChange={e => setSelectedAthleteId(e.target.value)}
                        >
                            <option value="">-- Select --</option>
                            {filteredAthletes.map(a => <option key={a.id} value={a.id}>{a.name}</option>)}
                        </select>
                        <div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none"><ChevronDown className="w-4 h-4" /></div>
                    </div>
                </div>
            </div>

            {/* CHART HEADER */}
            <div className="text-center mb-8">
                <h2 className="text-2xl font-bold underline decoration-2 underline-offset-8">{selectedCategory} Results {selectedEvent}</h2>
            </div>

            {/* CHARTS AREA */}
            <div className="flex flex-col lg:flex-row gap-8 items-stretch h-[600px] max-w-7xl mx-auto">
                
                {/* MAIN CHART */}
                <div className="w-full lg:w-3/4 relative flex flex-col">
                    <div className="relative h-full w-full pl-12 pb-32 border-l border-black flex flex-col">
                        {/* Y Axis Ticks */}
                        <div className="absolute left-0 top-0 bottom-32 w-full flex flex-col justify-between -ml-12 pointer-events-none">
                            {Array.from({length: 10}, (_, i) => 9 - i).map(val => (
                                <div key={val} className="flex items-center w-full">
                                    <span className="w-10 text-right pr-2 text-xs font-bold text-black">{val}</span>
                                    <div className="w-full border-t border-gray-200"></div>
                                </div>
                            ))}
                        </div>
                        
                        {/* Y Axis Label */}
                        <div className="absolute -left-10 top-1/2 -translate-y-16 -rotate-90 text-xs font-bold text-black whitespace-nowrap origin-center">
                            Athletes Per Rank Category
                        </div>

                        {/* Bars */}
                        <div className="relative flex items-end h-full w-full z-10 gap-2 md:gap-6 lg:gap-8 px-2">
                            {activeData.main.map((group, idx) => (
                                <ChartGroup 
                                    key={idx} 
                                    data={group} 
                                    maxVal={activeData.yAxisMax} 
                                    activeColors={activeData.colors} 
                                    activeTextColors={activeData.textColors}
                                    activeAthlete={activeAthlete}
                                />
                            ))}
                        </div>

                        {/* X Axis Title */}
                        <div className="absolute bottom-4 left-0 right-0 text-center font-bold text-sm text-black">Final Rank</div>
                    </div>
                </div>

                {/* OUTLIER CHART */}
                <div className="w-full lg:w-1/4 relative flex flex-col">
                    <div className="relative h-full w-full pl-12 pb-32 border-l border-black flex flex-col">
                        {/* Y Axis Ticks */}
                        <div className="absolute left-0 top-0 bottom-32 w-full flex flex-col justify-between -ml-12 pointer-events-none">
                            {[...Array(9)].map((_, i) => {
                                const val = activeData.outlierMax - (i * (activeData.outlierMax > 50 ? 10 : 5)); 
                                const step = activeData.outlierMax / 8;
                                const label = Math.round(activeData.outlierMax - (i * step));
                                return (
                                    <div key={i} className="flex items-center w-full">
                                        <span className="w-10 text-right pr-2 text-xs font-bold text-black">{label}</span>
                                        <div className="w-full border-t border-gray-200"></div>
                                    </div>
                                )
                            })}
                            <div className="flex items-center w-full"><span className="w-10 text-right pr-2 text-xs font-bold text-black">0</span><div className="w-full border-t border-gray-200"></div></div>
                        </div>

                        {/* Bars */}
                        <div className="relative flex items-end justify-center h-full w-full z-10 px-4">
                            <ChartGroup 
                                data={activeData.outlier} 
                                maxVal={activeData.outlierMax} 
                                activeColors={activeData.colors} 
                                activeTextColors={activeData.textColors}
                                activeAthlete={activeAthlete}
                            />
                        </div>

                        {/* X Axis Title */}
                        <div className="absolute bottom-4 left-0 right-0 text-center font-bold text-sm text-black">Final Rank</div>
                    </div>
                </div>

            </div>
        </div>
    );
};

export default App;
